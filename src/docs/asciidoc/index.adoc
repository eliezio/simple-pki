= Simple PKI API
EliÃ©zio Oliveira;
:doctype: book
:icons: font
:source-highlighter: highlightjs
:toc: left
:toclevels: 3
:sectlinks:

:snippets: ../../../build/generated-snippets
:base-path: /pki/v1

:operation-curl-request-title: Example request
:operation-path-parameters-title: Example request parameters
:operation-http-response-title: Example response
:operation-response-headers-title: Example response headers

Version {gradle-project-version}

The available services provided by the Simple-PKI are documented below.

TIP: The file link:openapi3.json[] contains a machine-readable specification of these services.
      You can import it directly into Postman, for example, using the menu option "Import -> Import From Link".

[[get-cacert]]
== Get CA Certificate

[.lead]
GET {base-path}/cacert

Retrieves the current CA certificate in X.509v3 PEM format as an attachment.

operation::get-cacert[snippets='curl-request,http-response']

[[get-crl]]
== Get CRL

[.lead]
GET {base-path}/crl

Retrieves the current Certificate Revocation List (CRL) in PEM format as an attachment.

operation::get-crl[snippets='curl-request,http-response']

[TIP]
====
To get an updated version of the CRL, the recommended approach is to fetch it conditionally,
by passing the date/time of the latest CRL edition you might have.
Using cURL would be:
[source,bash]
----
$ curl 'http://localhost:8080/pki/v1/crl' -i -X GET \
    --time-cond 'Sat, 13 Apr 2019 10:17:34 GMT'
----

If the CRL has _not_ been updated so far, the HTTP response will be:

include::{snippets}/get-cond-crl/http-response.adoc[]

Otherwise you'll receive a normal CRL as a PEM attachment like before.
====

[[issue-cert]]
== Generate a certificate

[.lead]
POST {base-path}/certificates

Generates a new End-Entity (i.e. Non-CA) certificate based on a Certificate Signing Request (CSR), to be signed by the CA.
The resulting certificate is returned in PEM format as an attachment.

It is an End-Entity certificate since it will always contain the following extensions:

[cols="2,5"]
|===
| Basic constraints
| CA=false footnote:[https://tools.ietf.org/html/rfc5280#section-4.2.1.9[See RFC5280, Section 4.2.1.9]]
| Key Usage
| digitalSignature, keyEncipherment footnote:[https://tools.ietf.org/html/rfc5280#section-4.2.1.3[See RFC5280, Section 4.2.1.3]]
| Extended Key Usage
| clientAuth, serverAuth footnote:[https://tools.ietf.org/html/rfc5280#section-4.2.1.12[See RFC5280, Section 4.2.1.12]]
|===

operation::issue-cert[snippets='curl-request,http-response,response-headers']

[[get-cert]]
== Get a certificate

[.lead]
GET {base-path}/certificates/{serialNumber}

Retrieve a certificate previously issued by this CA, and returns it in PEM format as an attachment.
You must provide the same serial number reported on the response header for the <<issue-cert>> endpoint
(or follow the <<how-to-extract-serial-number>>).

operation::get-cert[snippets='curl-request,path-parameters,http-response']

[[revoke-cert]]
== Revoke a certificate

[.lead]
DELETE {base-path}/certificates/{serialNumber}

Revokes a certificate previously generated by the CA.
You must provide the same serial number reported on the response header for the <<issue-cert>> endpoint.

[[how-to-extract-serial-number]]
.Retrieving Certificate Serial Number
****
Alternatively, you can extract the certificate's serial number by using OpenSSL CLI as follows:
[source,subs="normal"]
----
$ openssl x509 -in __cert.pem__ -serial -noout
----
****

operation::revoke-cert[snippets='curl-request,path-parameters,http-response']
